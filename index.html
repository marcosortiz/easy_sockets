<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <title>Easy sockets by marcosortiz</title>
  </head>

  <body>
    <header>
      <div class="inner">
        <h1>Easy sockets</h1>
        <h2>Over and over I see developers struggling to implement basic sockets with features available on ruby socket stdlib.</h2>
        <a href="https://github.com/marcosortiz/easy_sockets" class="button"><small>View project on</small> GitHub</a>
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">
          <h1>
<a id="easy-sockets" class="anchor" href="#easy-sockets" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Easy Sockets</h1>

<p><a href="https://rubygems.org/gems/easy_sockets"><img src="https://badge.fury.io/rb/easy_sockets.svg" alt="Gem Version"></a>
<a href="https://travis-ci.org/marcosortiz/easy_sockets"><img src="https://travis-ci.org/marcosortiz/easy_sockets.svg?branch=master" alt="Build Status"></a>
<a href="https://gemnasium.com/marcosortiz/easy_sockets"><img src="https://gemnasium.com/marcosortiz/easy_sockets.svg" alt="Dependency Status"></a>
<a href="https://codeclimate.com/github/marcosortiz/easy_sockets"><img src="https://codeclimate.com/github/marcosortiz/easy_sockets/badges/gpa.svg" alt="Code Climate"></a>
<a href="https://codeclimate.com/github/marcosortiz/easy_sockets/coverage"><img src="https://codeclimate.com/github/marcosortiz/easy_sockets/badges/coverage.svg" alt="Coverage Status"></a></p>

<h2>
<a id="description" class="anchor" href="#description" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Description</h2>

<p>Over and over I see developers struggling to implement basic sockets with features available on ruby socket stdlib.</p>

<p>easy_sockets, takes care of basic details that usually are overlooked by developers when implementing TCP/Unix sockets from scratch.</p>

<p>I also strongly recommend <a href="http://www.jstorimer.com/products/working-with-tcp-sockets">the following book</a> if you want to learn more about TCP sockets.</p>

<blockquote>
<p>UDP socket support is comming soon.</p>
</blockquote>

<h3>
<a id="dependencies" class="anchor" href="#dependencies" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Dependencies</h3>

<p>easy_sockets only uses the following ruby stdlib gems:</p>

<ul>
<li>sockets</li>
<li>logger</li>
<li>timeout (just to raise Timeout::Error)</li>
</ul>

<h3>
<a id="transparent-idempotent-connect-and-disconnect-operations" class="anchor" href="#transparent-idempotent-connect-and-disconnect-operations" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Transparent idempotent connect and disconnect operations</h3>

<p>You don't needneed to worry about connecting your socket (you can still call it if you want). All you need to do is call <code>send_msg</code>. If the socket object is not connected yet, it will automatically try to connect the socket before sending the message. You still need to disconnect your socket after using it.</p>

<p>The <code>connect</code> and <code>disconnect</code> methods are idempotent methods. That means you can call them over and over again and they will only try to do something (connect and disconnect respectively) when the instance of your socket object is disconnected and connected respectively.</p>

<p>The code bellow illustrates this:</p>

<div class="highlight highlight-source-ruby"><pre>irb(main):<span class="pl-c1">001</span>:<span class="pl-c1">0</span><span class="pl-k">&gt;</span> <span class="pl-k">require</span> <span class="pl-s"><span class="pl-pds">'</span>easy_sockets<span class="pl-pds">'</span></span>
=&gt; <span class="pl-c1">true</span>
irb(main):<span class="pl-c1">002</span>:<span class="pl-c1">0</span><span class="pl-k">&gt;</span> s <span class="pl-k">=</span> <span class="pl-c1">EasySockets</span>::<span class="pl-c1">TcpSocket</span>.<span class="pl-k">new</span>
=&gt; <span class="pl-c">#&lt;EasySockets::TcpSocket:0x007fd16bb69308 @logger=nil, @timeout=0.5, @separator="\r\n", @connected=false, @port=2000, @host="127.0.0.1"&gt;</span>
irb(main):<span class="pl-c1">003</span>:<span class="pl-c1">0</span><span class="pl-k">&gt;</span> s.connected
=&gt; <span class="pl-c1">false</span>
irb(main):<span class="pl-c1">004</span>:<span class="pl-c1">0</span><span class="pl-k">&gt;</span> s.connect
=&gt; <span class="pl-c1">true</span>
irb(main):<span class="pl-c1">005</span>:<span class="pl-c1">0</span><span class="pl-k">&gt;</span> s.connected
=&gt; <span class="pl-c1">true</span>
irb(main):<span class="pl-c1">006</span>:<span class="pl-c1">0</span><span class="pl-k">&gt;</span> s.connect
=&gt; <span class="pl-c1">nil</span>
irb(main):<span class="pl-c1">007</span>:<span class="pl-c1">0</span><span class="pl-k">&gt;</span> s.connect
=&gt; <span class="pl-c1">nil</span>
irb(main):008:<span class="pl-c1">0</span><span class="pl-k">&gt;</span> s.connected
=&gt; <span class="pl-c1">true</span>
irb(main):009:<span class="pl-c1">0</span><span class="pl-k">&gt;</span> s.disconnect
=&gt; <span class="pl-c1">true</span>
irb(main):<span class="pl-c1">010</span>:<span class="pl-c1">0</span><span class="pl-k">&gt;</span> s.connected
=&gt; <span class="pl-c1">false</span>
irb(main):<span class="pl-c1">011</span>:<span class="pl-c1">0</span><span class="pl-k">&gt;</span> s.disconnect
=&gt; <span class="pl-c1">nil</span>
irb(main):<span class="pl-c1">012</span>:<span class="pl-c1">0</span><span class="pl-k">&gt;</span> s.disconnect
=&gt; <span class="pl-c1">nil</span></pre></div>

<h3>
<a id="safe-connect-read-and-write-timeout-implementation" class="anchor" href="#safe-connect-read-and-write-timeout-implementation" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Safe connect, read and write timeout implementation</h3>

<p>There is a lot of material on the internet saying <a href="http://www.mikeperham.com/2015/05/08/timeout-rubys-most-dangerous-api/">why you should not use ruby timeout stdlib</a>. However, over and over I see developers using the timeout stdlib for production code!</p>

<p>easy_sockets implements connect, read and write timeouts using <a href="http://ruby-doc.org/core-2.3.1/IO.html#method-c-select">IO.select</a>.</p>

<h3>
<a id="framing-messages" class="anchor" href="#framing-messages" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Framing Messages</h3>

<p>Usually, if you don't want to open and close a new connection everytime you need to send something to the server, you need to implement some sort of message framing. Openning (and closing) a new connection for each message, generates unnecessary overhead. While this might be ok for some communications where the messsage exchange rate is low, it might be a show stopper when this rate needs to be bigger.</p>

<p>Message framing is an agreement between client and server on the message format. That way clients and server can signal that one message is ending and another on is beginning.</p>

<p>There are numerous ways of framing messages. easy_sockets support 2:</p>

<ol>
<li><p><strong>Message separators:</strong> When pass the <code>:separator</code> option when creating your socket, easy_sockets will add it to the end of the message. For instance, if you setup <code>separator: "\r\n"</code> and you call <code>send_msg("some_message")</code>, the server will receive <code>"some_message\r\n"</code>.</p></li>
<li><p><strong>No separators</strong>: When you pass the option <code>no_separator: true</code> when creating your socket, easy_sockets will not add anything to the end of the message. This is useful when both client and server uses a more specific protocol. For instance, both client and server know that the first 4 bytes of the message represent and little ending integer, and depending on the value of that integer, the message will have a specific size and format.</p></li>
</ol>

<p>Whether to use separators or not, is totally up to what both client and server expects.</p>

<blockquote>
<p>If you decide to use new lines as the message separator, remember that it is <code>\n</code> on Unix systems but <code>\r\n</code> on Windows. So, be sure that both client and server are using the same separator.</p>
</blockquote>

<h2>
<a id="installation" class="anchor" href="#installation" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Installation</h2>

<p>Add this line to your application's Gemfile:</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">gem</span> <span class="pl-s"><span class="pl-pds">'</span>easy_sockets<span class="pl-pds">'</span></span></pre></div>

<p>And then execute:</p>

<pre><code>$ bundle
</code></pre>

<p>Or install it yourself as:</p>

<pre><code>$ gem install easy_sockets
</code></pre>

<h2>
<a id="usage" class="anchor" href="#usage" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Usage</h2>

<p>Make sure you have netcat installed on your system. We will use it to emulate our servers.</p>

<h3>
<a id="tcp-sockets" class="anchor" href="#tcp-sockets" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>TCP Sockets</h3>

<p>Open up a terminal window and type the following to start a TCP server:</p>

<div class="highlight highlight-source-shell"><pre>nc -ckl 2500</pre></div>

<p>On another terminal window, run the following <a href="https://github.com/marcosortiz/easy_sockets/blob/master/examples/tcp_socket.rb">code</a> to start the client:</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">require</span> <span class="pl-s"><span class="pl-pds">'</span>easy_sockets<span class="pl-pds">'</span></span>

host <span class="pl-k">=</span> <span class="pl-c1">ARGV</span>[<span class="pl-c1">0</span>] <span class="pl-k">||</span> <span class="pl-s"><span class="pl-pds">'</span>127.0.0.1<span class="pl-pds">'</span></span>

port <span class="pl-k">=</span> <span class="pl-c1">ARGV</span>[<span class="pl-c1">1</span>].to_i
port <span class="pl-k">=</span> <span class="pl-c1">2500</span> <span class="pl-k">if</span> port <span class="pl-k">&lt;=</span> <span class="pl-c1">0</span>

opts <span class="pl-k">=</span> {
    <span class="pl-c1">host:</span>      host,
    <span class="pl-c1">port:</span>      port,
    <span class="pl-c1">timeout:</span>   <span class="pl-c1">300</span>,
    <span class="pl-c1">separator:</span> <span class="pl-s"><span class="pl-pds">"</span><span class="pl-cce">\r\n</span><span class="pl-pds">"</span></span>,
    <span class="pl-c1">logger:</span> <span class="pl-c1">Logger</span>.<span class="pl-k">new</span>(<span class="pl-c1">STDOUT</span>),
}
s <span class="pl-k">=</span> <span class="pl-c1">EasySockets</span>::<span class="pl-c1">TcpSocket</span>.<span class="pl-k">new</span>(opts)
[<span class="pl-c1">:INT</span>, <span class="pl-c1">:QUIT</span>, <span class="pl-c1">:TERM</span>].each <span class="pl-k">do </span>|<span class="pl-smi">signal</span>|
    <span class="pl-c1">Signal</span>.trap(signal) <span class="pl-k">do</span>
        exit
    <span class="pl-k">end</span>
<span class="pl-k">end</span>

<span class="pl-k">loop</span> <span class="pl-k">do</span>
    puts <span class="pl-s"><span class="pl-pds">"</span>Please write the message you want to send and hit ENTER, or type Ctrl+c to quit:<span class="pl-pds">"</span></span>
    msg <span class="pl-k">=</span> gets.chomp
    s.send_msg(msg)
<span class="pl-k">end</span></pre></div>

<p>Then typing <code>sample_request</code> in the client terminal, you should see:</p>

<pre><code>$ bundle exec ruby examples/tcp_socket.rb 
Please write the message you want to send and hit ENTER, or type Ctrl+c to quit:
sample_request
D, [2016-06-30T15:17:39.648945 #90385] DEBUG -- : Successfully connected to tcp://127.0.0.1:2500.
D, [2016-06-30T15:17:39.649044 #90385] DEBUG -- : Sending "sample_request\r\n"
</code></pre>

<p>And the server terminal window should display:</p>

<pre><code>$ nc -ckl 2500
sample_request

</code></pre>

<p>Then type <code>sample_response</code> on the server terminal window, and you should see:</p>

<pre><code>$ nc -ckl 2500
sample_request
sample_response

</code></pre>

<p>And the client window should show:</p>

<pre><code>$ bundle exec ruby examples/tcp_socket.rb 
Please write the message you want to send and hit ENTER, or type Ctrl+c to quit:
sample_request
D, [2016-06-30T15:17:39.648945 #90385] DEBUG -- : Successfully connected to tcp://127.0.0.1:2500.
D, [2016-06-30T15:17:39.649044 #90385] DEBUG -- : Sending "sample_request\r\n"
D, [2016-06-30T15:19:52.494791 #90385] DEBUG -- : Got "sample_response\r\n"
Please write the message you want to send and hit ENTER, or type Ctrl+c to quit:

</code></pre>

<p>Press <code>Ctrl+c</code> on the client and server terminal windows to terminate both.</p>

<h3>
<a id="unix-sockets" class="anchor" href="#unix-sockets" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Unix Sockets</h3>

<p>Open up a terminal window and type the following to start a Unix server:</p>

<div class="highlight highlight-source-shell"><pre>nc -Ul /tmp/test_socket</pre></div>

<p>On another terminal window, run the following <a href="https://github.com/marcosortiz/easy_sockets/blob/master/examples/unix_socket.rb">code</a> to start the client:</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">require</span> <span class="pl-s"><span class="pl-pds">'</span>easy_sockets<span class="pl-pds">'</span></span>

host <span class="pl-k">=</span> <span class="pl-c1">ARGV</span>[<span class="pl-c1">0</span>] <span class="pl-k">||</span> <span class="pl-s"><span class="pl-pds">'</span>127.0.0.1<span class="pl-pds">'</span></span>

socket_path <span class="pl-k">=</span> <span class="pl-c1">ARGV</span>[<span class="pl-c1">1</span>]
socket_path <span class="pl-k">||=</span> <span class="pl-s"><span class="pl-pds">'</span>/tmp/test_socket<span class="pl-pds">'</span></span>

opts <span class="pl-k">=</span> {
    <span class="pl-c1">host:</span>      host,
    <span class="pl-c1">socket_path:</span> socket_path,
    <span class="pl-c1">timeout:</span>   <span class="pl-c1">300</span>,
    <span class="pl-c1">separator:</span> <span class="pl-s"><span class="pl-pds">"</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>,
    <span class="pl-c1">logger:</span> <span class="pl-c1">Logger</span>.<span class="pl-k">new</span>(<span class="pl-c1">STDOUT</span>),
}
s <span class="pl-k">=</span> <span class="pl-c1">EasySockets</span>::<span class="pl-c1">UnixSocket</span>.<span class="pl-k">new</span>(opts)
[<span class="pl-c1">:INT</span>, <span class="pl-c1">:QUIT</span>, <span class="pl-c1">:TERM</span>].each <span class="pl-k">do </span>|<span class="pl-smi">signal</span>|
    <span class="pl-c1">Signal</span>.trap(signal) <span class="pl-k">do</span>
        exit
    <span class="pl-k">end</span>
<span class="pl-k">end</span>

<span class="pl-k">loop</span> <span class="pl-k">do</span>
    puts <span class="pl-s"><span class="pl-pds">"</span>Please write the message you want to send and hit ENTER, or type Ctrl+c to quit:<span class="pl-pds">"</span></span>
    msg <span class="pl-k">=</span> gets.chomp
    s.send_msg(msg)
<span class="pl-k">end</span></pre></div>

<p>Then typing <code>sample_request</code> in the client terminal, you should see:</p>

<pre><code>marcosortiz@~/dev/easy_sockets$ bundle exec ruby examples/unix_socket.rb 
Please write the message you want to send and hit ENTER, or type Ctrl+c to quit:
sample_request
D, [2016-06-30T15:38:10.303188 #96993] DEBUG -- : Successfully connected to /tmp/test_socket.
D, [2016-06-30T15:38:10.303265 #96993] DEBUG -- : Sending "sample_request\n"
</code></pre>

<p>And the server terminal window should display:</p>

<pre><code>$ nc -Ul /tmp/test_socket
sample_request

</code></pre>

<p>Then type <code>sample_response</code> on the server terminal window, and you should see:</p>

<pre><code>$ nc -Ul /tmp/test_socket
sample_request
sample_response    

</code></pre>

<p>And the client window should show:</p>

<pre><code>$ bundle exec ruby examples/unix_socket.rb 
Please write the message you want to send and hit ENTER, or type Ctrl+c to quit:
sample_request
D, [2016-06-30T15:38:10.303188 #96993] DEBUG -- : Successfully connected to /tmp/test_socket.
D, [2016-06-30T15:38:10.303265 #96993] DEBUG -- : Sending "sample_request\n"
D, [2016-06-30T15:38:23.503411 #96993] DEBUG -- : "sample_response\n"
D, [2016-06-30T15:38:23.503488 #96993] DEBUG -- : Got "sample_response\n"
Please write the message you want to send and hit ENTER, or type Ctrl+c to quit:

</code></pre>

<p>Press <code>Ctrl+c</code> on the client and server terminal windows to terminate both. Also, type <code>rm -rf /tmp/test_socket</code> to remove the socket file.</p>

<h2>
<a id="development" class="anchor" href="#development" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Development</h2>

<p>After checking out the repo, run <code>bin/setup</code> to install dependencies. Then, run <code>rake spec</code> to run the tests. You can also run <code>bin/console</code> for an interactive prompt that will allow you to experiment.</p>

<p>To install this gem onto your local machine, run <code>bundle exec rake install</code>. To release a new version, update the version number in <code>version.rb</code>, and then run <code>bundle exec rake release</code>, which will create a git tag for the version, push git commits and tags, and push the <code>.gem</code> file to <a href="https://rubygems.org">rubygems.org</a>.</p>

<h2>
<a id="5-contributing" class="anchor" href="#5-contributing" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>5. Contributing</h2>

<p>Bug reports and pull requests are welcome on GitHub at <a href="https://github.com/marcosortiz/easy_sockets">https://github.com/marcosortiz/easy_sockets</a>.</p>

<h2>
<a id="6-license" class="anchor" href="#6-license" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>6. License</h2>

<p>The gem is available as open source under the terms of the <a href="http://opensource.org/licenses/MIT">MIT License</a>.</p>
        </section>

        <aside id="sidebar">
          <a href="https://github.com/marcosortiz/easy_sockets/zipball/master" class="button">
            <small>Download</small>
            .zip file
          </a>
          <a href="https://github.com/marcosortiz/easy_sockets/tarball/master" class="button">
            <small>Download</small>
            .tar.gz file
          </a>

          <p class="repo-owner"><a href="https://github.com/marcosortiz/easy_sockets"></a> is maintained by <a href="https://github.com/marcosortiz">marcosortiz</a>.</p>

          <p>This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the Architect theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.</p>
        </aside>
      </div>
    </div>

  
  </body>
</html>
